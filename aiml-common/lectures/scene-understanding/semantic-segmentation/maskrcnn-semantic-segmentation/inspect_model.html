
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Mask R-CNN - Inspect Trained Model &#8212; Data Mining</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/proof.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/clipboard.min.js"></script>
    <script src="../../../../../_static/copybutton.js"></script>
    <script src="../../../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script src="../../../../../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://pantelis.github.io/data-mining/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.html" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Mask R-CNN - Inspect Weights of a Trained Model" href="inspect_weights.html" />
    <link rel="prev" title="Mask R-CNN - Inspect Training Data" href="inspect_data.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Data Mining</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Syllabus
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../syllabus/_index.html">
   Syllabus
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Data Mining
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ai-intro/course-introduction/_index.html">
   Course Introduction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ai-intro/data-science-360/_index.html">
   Data Science 360
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ai-intro/pipelines/_index.html">
   ML Pipelines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../uber-ml-arch-case-study/_index.html">
   A Case Study of an ML Architecture - Uber
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  The Learning Problem
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../learning-problem/_index.html">
   The Learning Problem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../regression/linear-regression/linear_regression.html">
   Linear Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../regression/linear-regression/regression-notebooks.html">
   Regression Notebooks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../optimization/maximum-likelihood/marginal_maximum_likelihood.html">
   Maximum Likelihood Estimation of a marginal model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../optimization/maximum-likelihood/conditional_maximum_likelihood.html">
   Maximum Likelihood (ML) Estimation of conditional models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../entropy/_index.html">
   Entropy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../optimization/sgd/_index.html">
   Stochastic Gradient Descent
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../classification/classification-intro/_index.html">
   Introduction to Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../classification/logistic-regression/_index.html">
   Logistic Regression
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Deep Neural Networks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../classification/perceptron/_index.html">
   The Neuron (Perceptron)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dnn/dnn-intro/_index.html">
   Deep Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dnn/backprop-intro/_index.html">
   Introduction to Backpropagation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dnn/backprop-dnn/_index.html">
   Backpropagation in Deep Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dnn/backprop-dnn-exercises/_index.html">
   Backpropagation DNN exercises
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../dnn/fashion-mnist-case-study.html">
   Fashion MNIST Case Study
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../optimization/regularization/_index.html">
   Regularization in Deep Neural Networks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Convolutional Neural Networks
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cnn/cnn-intro/_index.html">
   Introduction to Convolutional Neural Networks
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cnn/cnn-layers/_index.html">
   CNN Architectures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cnn/cnn-example-architectures/_index.html">
   CNN Example Architectures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cnn/cnn-example-architectures/using_convnets_with_small_datasets.html">
   Using convnets with small datasets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../feature-extraction-resnet/index.html">
   Feature Extraction via Residual Networks
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Transfer Learning
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../transfer-learning/transfer-learning-introduction.html">
   Introduction to Transfer Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../transfer-learning/transfer_learning_tutorial.html">
   Transfer Learning for Computer Vision Tutorial
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Scene Understanding
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../scene-understanding-intro/index.html">
   Introduction to Scene Understanding
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../object-detection/object-detection-intro/index.html">
   Object Detection
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../object-detection/detection-metrics/index.html">
     Object Detection and Semantic Segmentation Metrics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../object-detection/rcnn-object-detection/index.html">
     Region-CNN (RCNN) Object Detection
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../object-detection/faster-rcnn-object-detection/index.html">
     Fast and Faster RCNN Object Detection
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   Semantic Segmentation
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="index.html">
     Mask R-CNN Semantic Segmentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="demo.html">
     Mask R-CNN Demo
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="inspect_data.html">
     Mask R-CNN - Inspect Training Data
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Mask R-CNN - Inspect Trained Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="inspect_weights.html">
     Mask R-CNN - Inspect Weights of a Trained Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="detectron2_tutorial.html">
     Detectron2 Beginnerâ€™s Tutorial
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Sequences and RNNs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rnn/introduction/_index.html">
   Introduction to Recurrent Neural Networks (RNN)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rnn/simple-rnn/_index.html">
   Simple RNN
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rnn/lstm/_index.html">
   The Long Short-Term Memory (LSTM) Cell Architecture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rnn/15_processing_sequences_using_rnns_and_cnns.html">
   Processing Sequences Using RNN
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Embeddings and NLP
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/nlp-intro/_index.html">
   Introduction to NLP
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/word2vec/_index.html">
   Word2Vec Embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/word2vec/word2vec-workshop.html">
   Word2Vec Workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/language-models/_index.html">
   RNN Language Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/language-models/simple-rnn-language-model.html">
   Simple RNN Language Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/language-models/cnn-language-model.html">
   CNN Language Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../nlp/nmt/_index.html">
   Neural Machine Translation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Classical Learning Methods
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../decision-trees/_index.html">
   Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../regression-trees/regression_trees.html">
   Regression tree stumps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ensemble/_index.html">
   Ensemble Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ensemble/random-forests/_index.html">
   Random Forests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ensemble/adaboost/index.html">
   Adaptive Boosting (AdaBoost)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ensemble/gradient-boosting/index.html">
   Gradient Boosting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ensemble/boosting-workshop/_index.html">
   Boosting workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pgm/bayesian-inference/_index.html">
   Bayesian Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pgm/bayesian-coin/_index.html">
   Bayesian Coin Flipping
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../classification/covid19-antibody-test/_index.html">
   COVID-19 Antibody Test
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Non-Parametric Methods
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../unsupervised/k-means/_index.html">
   K-means Clustering
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../density-estimation/knn/_index.html">
   k-Nearest Neighbors (kNN) Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../density-estimation/knn-workshop/_index.html">
   kNN Workshop
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dimensionality Reduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../pca/_index.html">
   Principal Component Analysis (PCA)
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Math Background
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../../ml-math/_index.html">
   Math for ML
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../ml-math/probability/_index.html">
     Probability Basics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../linear-algebra/_index.html">
     Linear Algebra for Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../../ml-math/calculus/_index.html">
     Calculus
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../python/_index.html">
   Learn Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../resources/environment/index.html">
   Your Programming Environment
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Assignments &amp; Projects
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../assignments/probability/probability-assignment-5/index.html">
   Probability Assignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../assignments/mle/poisson-regression-1/index.html">
   Bike Rides and the Poisson Model
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/pantelis/data-mining"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/pantelis/data-mining/issues/new?title=Issue%20on%20page%20%2Faiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../../../_sources/aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation/inspect_model.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Mask R-CNN - Inspect Trained Model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configurations">
   Configurations
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notebook-preferences">
   Notebook Preferences
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-validation-dataset">
   Load Validation Dataset
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-model">
   Load Model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-detection">
   Run Detection
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#precision-recall">
     Precision-Recall
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-map-iou-50-on-batch-of-images">
     Compute mAP @ IoU=50 on Batch of Images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-by-step-prediction">
   Step by Step Prediction
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-1-region-proposal-network">
   Stage 1: Region Proposal Network
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-rpn-targets">
     1.a RPN Targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-rpn-predictions">
     1.b RPN Predictions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-2-proposal-classification">
   Stage 2: Proposal Classification
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-proposal-classification">
     2.a Proposal Classification
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#c-step-by-step-detection">
     2.c Step by Step Detection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#apply-bounding-box-refinement">
       Apply Bounding Box Refinement
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#filter-low-confidence-detections">
       Filter Low Confidence Detections
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#per-class-non-max-suppression">
       Per-Class Non-Max Suppression
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-3-generating-masks">
   Stage 3: Generating Masks
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-mask-targets">
     3.a Mask Targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-predicted-masks">
     3.b Predicted Masks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-activations">
   Visualize Activations
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Mask R-CNN - Inspect Trained Model</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Mask R-CNN - Inspect Trained Model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#configurations">
   Configurations
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#notebook-preferences">
   Notebook Preferences
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-validation-dataset">
   Load Validation Dataset
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-model">
   Load Model
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#run-detection">
   Run Detection
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#precision-recall">
     Precision-Recall
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#compute-map-iou-50-on-batch-of-images">
     Compute mAP @ IoU=50 on Batch of Images
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-by-step-prediction">
   Step by Step Prediction
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-1-region-proposal-network">
   Stage 1: Region Proposal Network
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-rpn-targets">
     1.a RPN Targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-rpn-predictions">
     1.b RPN Predictions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-2-proposal-classification">
   Stage 2: Proposal Classification
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-proposal-classification">
     2.a Proposal Classification
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#c-step-by-step-detection">
     2.c Step by Step Detection
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#apply-bounding-box-refinement">
       Apply Bounding Box Refinement
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#filter-low-confidence-detections">
       Filter Low Confidence Detections
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#per-class-non-max-suppression">
       Per-Class Non-Max Suppression
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stage-3-generating-masks">
   Stage 3: Generating Masks
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-mask-targets">
     3.a Mask Targets
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-predicted-masks">
     3.b Predicted Masks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#visualize-activations">
   Visualize Activations
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="mask-r-cnn-inspect-trained-model">
<h1>Mask R-CNN - Inspect Trained Model<a class="headerlink" href="#mask-r-cnn-inspect-trained-model" title="Permalink to this headline">#</a></h1>
<p>Code and visualizations to test, debug, and evaluate the Mask R-CNN model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">patches</span>

<span class="c1"># Root directory of the project</span>
<span class="n">ROOT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;../../&quot;</span><span class="p">)</span>

<span class="c1"># Import Mask RCNN</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">)</span>  <span class="c1"># To find local version of the library</span>
<span class="kn">from</span> <span class="nn">mrcnn</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">mrcnn</span> <span class="kn">import</span> <span class="n">visualize</span>
<span class="kn">from</span> <span class="nn">mrcnn.visualize</span> <span class="kn">import</span> <span class="n">display_images</span>
<span class="kn">import</span> <span class="nn">mrcnn.model</span> <span class="k">as</span> <span class="nn">modellib</span>
<span class="kn">from</span> <span class="nn">mrcnn.model</span> <span class="kn">import</span> <span class="n">log</span>

<span class="o">%</span><span class="k">matplotlib</span> inline 

<span class="c1"># Directory to save logs and trained model</span>
<span class="n">MODEL_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>

<span class="c1"># Local path to trained weights file</span>
<span class="n">COCO_MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;mask_rcnn_coco.h5&quot;</span><span class="p">)</span>
<span class="c1"># Download COCO trained weights from Releases if needed</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">COCO_MODEL_PATH</span><span class="p">):</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">download_trained_weights</span><span class="p">(</span><span class="n">COCO_MODEL_PATH</span><span class="p">)</span>

<span class="c1"># Path to Shapes trained weights</span>
<span class="n">SHAPES_MODEL_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROOT_DIR</span><span class="p">,</span> <span class="s2">&quot;mask_rcnn_shapes.h5&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using TensorFlow backend.
</pre></div>
</div>
</div>
</div>
</section>
<section id="configurations">
<h1>Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run one of the code blocks</span>

<span class="c1"># Shapes toy dataset</span>
<span class="c1"># import shapes</span>
<span class="c1"># config = shapes.ShapesConfig()</span>

<span class="c1"># MS COCO Dataset</span>
<span class="kn">import</span> <span class="nn">coco</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">CocoConfig</span><span class="p">()</span>
<span class="n">COCO_DIR</span> <span class="o">=</span> <span class="s2">&quot;path to COCO dataset&quot;</span>  <span class="c1"># TODO: enter value here</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Override the training configurations with a few</span>
<span class="c1"># changes for inferencing.</span>
<span class="k">class</span> <span class="nc">InferenceConfig</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
    <span class="c1"># Run detection on one image at a time</span>
    <span class="n">GPU_COUNT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">IMAGES_PER_GPU</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">InferenceConfig</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Configurations:
BACKBONE_SHAPES                [[256 256]
 [128 128]
 [ 64  64]
 [ 32  32]
 [ 16  16]]
BACKBONE_STRIDES               [4, 8, 16, 32, 64]
BATCH_SIZE                     1
BBOX_STD_DEV                   [ 0.1  0.1  0.2  0.2]
DETECTION_MAX_INSTANCES        100
DETECTION_MIN_CONFIDENCE       0.5
DETECTION_NMS_THRESHOLD        0.3
GPU_COUNT                      1
IMAGES_PER_GPU                 1
IMAGE_MAX_DIM                  1024
IMAGE_MIN_DIM                  800
IMAGE_PADDING                  True
IMAGE_SHAPE                    [1024 1024    3]
LEARNING_MOMENTUM              0.9
LEARNING_RATE                  0.002
MASK_POOL_SIZE                 14
MASK_SHAPE                     [28, 28]
MAX_GT_INSTANCES               100
MEAN_PIXEL                     [ 123.7  116.8  103.9]
MINI_MASK_SHAPE                (56, 56)
NAME                           coco
NUM_CLASSES                    81
POOL_SIZE                      7
POST_NMS_ROIS_INFERENCE        1000
POST_NMS_ROIS_TRAINING         2000
ROI_POSITIVE_RATIO             0.33
RPN_ANCHOR_RATIOS              [0.5, 1, 2]
RPN_ANCHOR_SCALES              (32, 64, 128, 256, 512)
RPN_ANCHOR_STRIDE              2
RPN_BBOX_STD_DEV               [ 0.1  0.1  0.2  0.2]
RPN_TRAIN_ANCHORS_PER_IMAGE    256
STEPS_PER_EPOCH                1000
TRAIN_ROIS_PER_IMAGE           128
USE_MINI_MASK                  True
USE_RPN_ROIS                   True
VALIDATION_STEPS               50
WEIGHT_DECAY                   0.0001
</pre></div>
</div>
</div>
</div>
</section>
<section id="notebook-preferences">
<h1>Notebook Preferences<a class="headerlink" href="#notebook-preferences" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Device to load the neural network on.</span>
<span class="c1"># Useful if you&#39;re training a model on the same </span>
<span class="c1"># machine, in which case use CPU and leave the</span>
<span class="c1"># GPU for training.</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;/cpu:0&quot;</span>  <span class="c1"># /cpu:0 or /gpu:0</span>

<span class="c1"># Inspect the model in training or inference modes</span>
<span class="c1"># values: &#39;inference&#39; or &#39;training&#39;</span>
<span class="c1"># TODO: code for &#39;training&#39; test mode not ready yet</span>
<span class="n">TEST_MODE</span> <span class="o">=</span> <span class="s2">&quot;inference&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_ax</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a Matplotlib Axes array to be used in</span>
<span class="sd">    all visualizations in the notebook. Provide a</span>
<span class="sd">    central point to control graph sizes.</span>
<span class="sd">    </span>
<span class="sd">    Adjust the size attribute to control how big to render images</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span> <span class="n">size</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-validation-dataset">
<h1>Load Validation Dataset<a class="headerlink" href="#load-validation-dataset" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build validation dataset</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s1">&#39;shapes&#39;</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">ShapesDataset</span><span class="p">()</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">load_shapes</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">coco</span><span class="o">.</span><span class="n">CocoDataset</span><span class="p">()</span>
    <span class="n">dataset</span><span class="o">.</span><span class="n">load_coco</span><span class="p">(</span><span class="n">COCO_DIR</span><span class="p">,</span> <span class="s2">&quot;minival&quot;</span><span class="p">)</span>

<span class="c1"># Must call before using the dataset</span>
<span class="n">dataset</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Images: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Classes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">),</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loading annotations into memory...
Done (t=4.86s)
creating index...
index created!
Images: 35185
Classes: [&#39;BG&#39;, &#39;person&#39;, &#39;bicycle&#39;, &#39;car&#39;, &#39;motorcycle&#39;, &#39;airplane&#39;, &#39;bus&#39;, &#39;train&#39;, &#39;truck&#39;, &#39;boat&#39;, &#39;traffic light&#39;, &#39;fire hydrant&#39;, &#39;stop sign&#39;, &#39;parking meter&#39;, &#39;bench&#39;, &#39;bird&#39;, &#39;cat&#39;, &#39;dog&#39;, &#39;horse&#39;, &#39;sheep&#39;, &#39;cow&#39;, &#39;elephant&#39;, &#39;bear&#39;, &#39;zebra&#39;, &#39;giraffe&#39;, &#39;backpack&#39;, &#39;umbrella&#39;, &#39;handbag&#39;, &#39;tie&#39;, &#39;suitcase&#39;, &#39;frisbee&#39;, &#39;skis&#39;, &#39;snowboard&#39;, &#39;sports ball&#39;, &#39;kite&#39;, &#39;baseball bat&#39;, &#39;baseball glove&#39;, &#39;skateboard&#39;, &#39;surfboard&#39;, &#39;tennis racket&#39;, &#39;bottle&#39;, &#39;wine glass&#39;, &#39;cup&#39;, &#39;fork&#39;, &#39;knife&#39;, &#39;spoon&#39;, &#39;bowl&#39;, &#39;banana&#39;, &#39;apple&#39;, &#39;sandwich&#39;, &#39;orange&#39;, &#39;broccoli&#39;, &#39;carrot&#39;, &#39;hot dog&#39;, &#39;pizza&#39;, &#39;donut&#39;, &#39;cake&#39;, &#39;chair&#39;, &#39;couch&#39;, &#39;potted plant&#39;, &#39;bed&#39;, &#39;dining table&#39;, &#39;toilet&#39;, &#39;tv&#39;, &#39;laptop&#39;, &#39;mouse&#39;, &#39;remote&#39;, &#39;keyboard&#39;, &#39;cell phone&#39;, &#39;microwave&#39;, &#39;oven&#39;, &#39;toaster&#39;, &#39;sink&#39;, &#39;refrigerator&#39;, &#39;book&#39;, &#39;clock&#39;, &#39;vase&#39;, &#39;scissors&#39;, &#39;teddy bear&#39;, &#39;hair drier&#39;, &#39;toothbrush&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-model">
<h1>Load Model<a class="headerlink" href="#load-model" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create model in inference mode</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">MaskRCNN</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;inference&quot;</span><span class="p">,</span> <span class="n">model_dir</span><span class="o">=</span><span class="n">MODEL_DIR</span><span class="p">,</span>
                              <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Set weights file path</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;shapes&quot;</span><span class="p">:</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">SHAPES_MODEL_PATH</span>
<span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">NAME</span> <span class="o">==</span> <span class="s2">&quot;coco&quot;</span><span class="p">:</span>
    <span class="n">weights_path</span> <span class="o">=</span> <span class="n">COCO_MODEL_PATH</span>
<span class="c1"># Or, uncomment to load the last model you trained</span>
<span class="c1"># weights_path = model.find_last()</span>

<span class="c1"># Load weights</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading weights &quot;</span><span class="p">,</span> <span class="n">weights_path</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-detection">
<h1>Run Detection<a class="headerlink" href="#run-detection" title="Permalink to this headline">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_id</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">)</span>
<span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span>\
    <span class="n">modellib</span><span class="o">.</span><span class="n">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">image_info</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image ID: </span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">image_id</span><span class="p">,</span> 
                                       <span class="n">dataset</span><span class="o">.</span><span class="n">image_reference</span><span class="p">(</span><span class="n">image_id</span><span class="p">)))</span>
<span class="c1"># Run object detection</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">detect</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Display results</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">get_ax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">display_instances</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> 
                            <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_class_id&quot;</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_bbox&quot;</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;gt_mask&quot;</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>image ID: coco.392144 (34940) http://cocodataset.org/#explore?id=392144
Processing 1 images
image                    shape: (1024, 1024, 3)       min:    0.00000  max:  255.00000
molded_images            shape: (1, 1024, 1024, 3)    min: -123.70000  max:  151.10000
image_metas              shape: (1, 89)               min:    0.00000  max: 1024.00000
gt_class_id              shape: (10,)                 min:    1.00000  max:   40.00000
gt_bbox                  shape: (10, 5)               min:    0.00000  max: 1024.00000
gt_mask                  shape: (1024, 1024, 10)      min:    0.00000  max:    1.00000
</pre></div>
</div>
<img alt="../../../../../_images/inspect_model_13_1.png" src="../../../../../_images/inspect_model_13_1.png" />
</div>
</div>
<section id="precision-recall">
<h2>Precision-Recall<a class="headerlink" href="#precision-recall" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Draw precision-recall curve</span>
<span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_ap</span><span class="p">(</span><span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span>
                                          <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">plot_precision_recall</span><span class="p">(</span><span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_15_0.png" src="../../../../../_images/inspect_model_15_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grid of ground truth objects and their predictions</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">plot_overlaps</span><span class="p">(</span><span class="n">gt_class_id</span><span class="p">,</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span>
                        <span class="n">overlaps</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_16_0.png" src="../../../../../_images/inspect_model_16_0.png" />
</div>
</div>
</section>
<section id="compute-map-iou-50-on-batch-of-images">
<h2>Compute mAP &#64; IoU=50 on Batch of Images<a class="headerlink" href="#compute-map-iou-50-on-batch-of-images" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute VOC-style Average Precision</span>
<span class="k">def</span> <span class="nf">compute_batch_ap</span><span class="p">(</span><span class="n">image_ids</span><span class="p">):</span>
    <span class="n">APs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">image_id</span> <span class="ow">in</span> <span class="n">image_ids</span><span class="p">:</span>
        <span class="c1"># Load image</span>
        <span class="n">image</span><span class="p">,</span> <span class="n">image_meta</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_mask</span> <span class="o">=</span>\
            <span class="n">modellib</span><span class="o">.</span><span class="n">load_image_gt</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
                                   <span class="n">image_id</span><span class="p">,</span> <span class="n">use_mini_mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Run object detection</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">detect</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Compute AP</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">AP</span><span class="p">,</span> <span class="n">precisions</span><span class="p">,</span> <span class="n">recalls</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span>\
            <span class="n">utils</span><span class="o">.</span><span class="n">compute_ap</span><span class="p">(</span><span class="n">gt_bbox</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_mask</span><span class="p">,</span>
                              <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rois&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;class_ids&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;masks&#39;</span><span class="p">])</span>
        <span class="n">APs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AP</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">APs</span>

<span class="c1"># Pick a set of random images</span>
<span class="n">image_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">image_ids</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">APs</span> <span class="o">=</span> <span class="n">compute_batch_ap</span><span class="p">(</span><span class="n">image_ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mAP @ IoU=50: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">APs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/lib/python3.5/dist-packages/scipy/ndimage/interpolation.py:600: UserWarning: From scipy 0.13.0, the output shape of zoom() is calculated with round() instead of int() - for these inputs the size of the returned array has changed.
  &quot;the returned array has changed.&quot;, UserWarning)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mAP @ IoU=50:  0.656323084916
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="step-by-step-prediction">
<h1>Step by Step Prediction<a class="headerlink" href="#step-by-step-prediction" title="Permalink to this headline">#</a></h1>
</section>
<section id="stage-1-region-proposal-network">
<h1>Stage 1: Region Proposal Network<a class="headerlink" href="#stage-1-region-proposal-network" title="Permalink to this headline">#</a></h1>
<p>The Region Proposal Network (RPN) runs a lightweight binary classifier on a lot of boxes (anchors) over the image and returns object/no-object scores. Anchors with high <em>objectness</em> score (positive anchors) are passed to the stage two to be classified.</p>
<p>Often, even positive anchors donâ€™t cover objects fully. So the RPN also regresses a refinement (a delta in location and size) to be applied to the anchors to shift it and resize it a bit to the correct boundaries of the object.</p>
<section id="a-rpn-targets">
<h2>1.a RPN Targets<a class="headerlink" href="#a-rpn-targets" title="Permalink to this headline">#</a></h2>
<p>The RPN targets are the training values for the RPN. To generate the targets, we start with a grid of anchors that cover the full image at different scales, and then we compute the IoU of the anchors with ground truth object. Positive anchors are those that have an IoU &gt;= 0.7 with any ground truth object, and negative anchors are those that donâ€™t cover any object by more than 0.3 IoU. Anchors in between (i.e. cover an object by IoU &gt;= 0.3 but &lt; 0.7) are considered neutral and excluded from training.</p>
<p>To train the RPN regressor, we also compute the shift and resizing needed to make the anchor cover the ground truth object completely.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate RPN trainig targets</span>
<span class="c1"># target_rpn_match is 1 for positive anchors, -1 for negative anchors</span>
<span class="c1"># and 0 for neutral anchors.</span>
<span class="n">target_rpn_match</span><span class="p">,</span> <span class="n">target_rpn_bbox</span> <span class="o">=</span> <span class="n">modellib</span><span class="o">.</span><span class="n">build_rpn_targets</span><span class="p">(</span>
    <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">gt_class_id</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;target_rpn_match&quot;</span><span class="p">,</span> <span class="n">target_rpn_match</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;target_rpn_bbox&quot;</span><span class="p">,</span> <span class="n">target_rpn_bbox</span><span class="p">)</span>

<span class="n">positive_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">negative_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">neutral_anchor_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">target_rpn_match</span><span class="p">[:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">positive_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">positive_anchor_ix</span><span class="p">]</span>
<span class="n">negative_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">negative_anchor_ix</span><span class="p">]</span>
<span class="n">neutral_anchors</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">neutral_anchor_ix</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;positive_anchors&quot;</span><span class="p">,</span> <span class="n">positive_anchors</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;negative_anchors&quot;</span><span class="p">,</span> <span class="n">negative_anchors</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;neutral anchors&quot;</span><span class="p">,</span> <span class="n">neutral_anchors</span><span class="p">)</span>

<span class="c1"># Apply refinement deltas to positive anchors</span>
<span class="n">refined_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">apply_box_deltas</span><span class="p">(</span>
    <span class="n">positive_anchors</span><span class="p">,</span>
    <span class="n">target_rpn_bbox</span><span class="p">[:</span><span class="n">positive_anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">RPN_BBOX_STD_DEV</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">,</span> <span class="n">refined_anchors</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>target_rpn_match         shape: (65472,)              min:   -1.00000  max:    1.00000
target_rpn_bbox          shape: (256, 4)              min:   -5.19860  max:    2.59641
positive_anchors         shape: (14, 4)               min:    5.49033  max:  973.25483
negative_anchors         shape: (242, 4)              min:  -22.62742  max: 1038.62742
neutral anchors          shape: (65216, 4)            min: -362.03867  max: 1258.03867
refined_anchors          shape: (14, 4)               min:    0.00000  max: 1023.99994
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display positive anchors before refinement (dotted) and</span>
<span class="c1"># after refinement (solid).</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">positive_anchors</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_23_0.png" src="../../../../../_images/inspect_model_23_0.png" />
</div>
</div>
</section>
<section id="b-rpn-predictions">
<h2>1.b RPN Predictions<a class="headerlink" href="#b-rpn-predictions" title="Permalink to this headline">#</a></h2>
<p>Here we run the RPN graph and display its predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run RPN sub-graph</span>
<span class="n">pillar</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span>  <span class="c1"># node to start searching from</span>

<span class="c1"># TF 1.4 and 1.9 introduce new versions of NMS. Search for all names to support TF 1.3~1.10</span>
<span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression:0&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">nms_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression/NonMaxSuppressionV2:0&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">nms_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#TF 1.9-1.10</span>
    <span class="n">nms_node</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/rpn_non_max_suppression/NonMaxSuppressionV3:0&quot;</span><span class="p">)</span>

<span class="n">rpn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;rpn_class&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;rpn_class&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;pre_nms_anchors&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/pre_nms_anchors:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/refined_anchors:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;refined_anchors_clipped&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">ancestor</span><span class="p">(</span><span class="n">pillar</span><span class="p">,</span> <span class="s2">&quot;ROI/refined_anchors_clipped:0&quot;</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;post_nms_anchor_ix&quot;</span><span class="p">,</span> <span class="n">nms_node</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;proposals&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>rpn_class                shape: (1, 65472, 2)         min:    0.00000  max:    1.00000
pre_nms_anchors          shape: (1, 10000, 4)         min: -362.03867  max: 1258.03870
refined_anchors          shape: (1, 10000, 4)         min: -1385.67920  max: 2212.44043
refined_anchors_clipped  shape: (1, 10000, 4)         min:    0.00000  max: 1024.00000
post_nms_anchor_ix       shape: (1000,)               min:    0.00000  max: 1477.00000
proposals                shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show top anchors by score (before refinement)</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sorted_anchor_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;rpn_class&#39;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">[</span><span class="n">sorted_anchor_ids</span><span class="p">[:</span><span class="n">limit</span><span class="p">]],</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_26_0.png" src="../../../../../_images/inspect_model_26_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show top anchors with refinement. Then with clipping to image boundaries</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">get_ax</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pre_nms_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;pre_nms_anchors&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">refined_anchors</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;refined_anchors&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">refined_anchors_clipped</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;refined_anchors_clipped&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">pre_nms_anchors</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span>
                     <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors_clipped</span><span class="p">[:</span><span class="n">limit</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_27_0.png" src="../../../../../_images/inspect_model_27_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show refined anchors after non-max suppression</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">rpn</span><span class="p">[</span><span class="s2">&quot;post_nms_anchor_ix&quot;</span><span class="p">][:</span><span class="n">limit</span><span class="p">]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_anchors_clipped</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_28_0.png" src="../../../../../_images/inspect_model_28_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show final proposals</span>
<span class="c1"># These are the same as the previous step (refined anchors </span>
<span class="c1"># after NMS) but with coordinates normalized to [0, 1] range.</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
<span class="c1"># Convert back to image coordinates for display</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">proposals</span> <span class="o">=</span> <span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;proposals&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">limit</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">])</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">refined_boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_29_0.png" src="../../../../../_images/inspect_model_29_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Measure the RPN recall (percent of objects covered by anchors)</span>
<span class="c1"># Here we measure recall for 3 different methods:</span>
<span class="c1"># - All anchors</span>
<span class="c1"># - All refined anchors</span>
<span class="c1"># - Refined anchors after NMS</span>
<span class="n">iou_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All Anchors (</span><span class="si">{:5}</span><span class="s2">)       Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">model</span><span class="o">.</span><span class="n">anchors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;refined_anchors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refined Anchors (</span><span class="si">{:5}</span><span class="s2">)   Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">rpn</span><span class="p">[</span><span class="s1">&#39;refined_anchors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>

<span class="n">recall</span><span class="p">,</span> <span class="n">positive_anchor_ids</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">compute_recall</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">gt_bbox</span><span class="p">,</span> <span class="n">iou_threshold</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Post NMS Anchors (</span><span class="si">{:5}</span><span class="s2">)  Recall: </span><span class="si">{:.3f}</span><span class="s2">  Positive anchors: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">recall</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_anchor_ids</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>All Anchors (65472)       Recall: 0.400  Positive anchors: 8
Refined Anchors (10000)   Recall: 0.900  Positive anchors: 65
Post NMS Anchors (   50)  Recall: 0.800  Positive anchors: 9
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="stage-2-proposal-classification">
<h1>Stage 2: Proposal Classification<a class="headerlink" href="#stage-2-proposal-classification" title="Permalink to this headline">#</a></h1>
<p>This stage takes the region proposals from the RPN and classifies them.</p>
<section id="a-proposal-classification">
<h2>2.a Proposal Classification<a class="headerlink" href="#a-proposal-classification" title="Permalink to this headline">#</a></h2>
<p>Run the classifier heads on proposals to generate class propbabilities and bounding box regressions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get input and output to classifier and mask heads.</span>
<span class="n">mrcnn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;proposals&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;probs&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_class&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;deltas&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_bbox&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;detections&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_detection&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>proposals                shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
probs                    shape: (1, 1000, 81)         min:    0.00000  max:    0.99999
deltas                   shape: (1, 1000, 81, 4)      min:   -3.26400  max:    3.83929
masks                    shape: (1, 100, 28, 28, 81)  min:    0.00000  max:    0.99984
detections               shape: (1, 100, 6)           min:    0.00000  max:  844.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get detection class IDs. Trim zero padding.</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">det_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">det_class_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">det_class_ids</span><span class="p">[:</span><span class="n">det_count</span><span class="p">]</span>
<span class="n">detections</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="n">det_count</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> detections: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">det_count</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">det_class_ids</span><span class="p">]))</span>

<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">detections</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> 
    <span class="n">refined_boxes</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">detections</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span>
    <span class="n">visibilities</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">detections</span><span class="p">),</span>
    <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Detections&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8 detections: [&#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;airplane&#39; &#39;airplane&#39; &#39;car&#39;]
</pre></div>
</div>
<img alt="../../../../../_images/inspect_model_34_1.png" src="../../../../../_images/inspect_model_34_1.png" />
</div>
</div>
</section>
<section id="c-step-by-step-detection">
<h2>2.c Step by Step Detection<a class="headerlink" href="#c-step-by-step-detection" title="Permalink to this headline">#</a></h2>
<p>Here we dive deeper into the process of processing the detections.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Proposals are in normalized coordinates. Scale them</span>
<span class="c1"># to image coordinates.</span>
<span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">IMAGE_SHAPE</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">proposals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;proposals&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

<span class="c1"># Class ID, score, and mask per proposal</span>
<span class="n">roi_class_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;probs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">roi_scores</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;probs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">roi_class_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">roi_positive_ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># How many ROIs vs empty rows?</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Valid proposals out of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">proposals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Positive ROIs&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">roi_positive_ixs</span><span class="p">)))</span>

<span class="c1"># Class counts</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">roi_class_names</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1000 Valid proposals out of 1000
71 Positive ROIs
[(&#39;BG&#39;, 929), (&#39;airplane&#39;, 23), (&#39;car&#39;, 11), (&#39;person&#39;, 37)]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display a random sample of proposals.</span>
<span class="c1"># Proposals classified as background are dotted, and</span>
<span class="c1"># the rest show their class and confidence score.</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limit</span><span class="p">)</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">ixs</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span>
                     <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">ixs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                     <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROIs Before Refinement&quot;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_37_0.png" src="../../../../../_images/inspect_model_37_0.png" />
</div>
</div>
<section id="apply-bounding-box-refinement">
<h3>Apply Bounding Box Refinement<a class="headerlink" href="#apply-bounding-box-refinement" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Class-specific bounding box shifts.</span>
<span class="n">roi_bbox_specific</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;deltas&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">proposals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">roi_class_ids</span><span class="p">]</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;roi_bbox_specific&quot;</span><span class="p">,</span> <span class="n">roi_bbox_specific</span><span class="p">)</span>

<span class="c1"># Apply bounding box transformations</span>
<span class="c1"># Shape: [N, (y1, x1, y2, x2)]</span>
<span class="n">refined_proposals</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">apply_box_deltas</span><span class="p">(</span>
    <span class="n">proposals</span><span class="p">,</span> <span class="n">roi_bbox_specific</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">BBOX_STD_DEV</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;refined_proposals&quot;</span><span class="p">,</span> <span class="n">refined_proposals</span><span class="p">)</span>

<span class="c1"># Show positive proposals</span>
<span class="c1"># ids = np.arange(roi_boxes.shape[0])  # Display all</span>
<span class="n">limit</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">roi_positive_ixs</span><span class="p">),</span> <span class="n">limit</span><span class="p">)</span>  <span class="c1"># Display random sample</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span>
                     <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_proposals</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">],</span>
                     <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">roi_positive_ixs</span><span class="p">][</span><span class="n">ids</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                     <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROIs After Refinement&quot;</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>roi_bbox_specific        shape: (1000, 4)             min:   -2.44748  max:    2.94838
refined_proposals        shape: (1000, 4)             min:   -8.00000  max: 1028.00000
</pre></div>
</div>
<img alt="../../../../../_images/inspect_model_39_1.png" src="../../../../../_images/inspect_model_39_1.png" />
</div>
</div>
</section>
<section id="filter-low-confidence-detections">
<h3>Filter Low Confidence Detections<a class="headerlink" href="#filter-low-confidence-detections" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove boxes classified as background</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Keep </span><span class="si">{}</span><span class="s2"> detections:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Keep 71 detections:
[  0   2   3   4   5   6   8   9  16  17  18  19  25  30  36  37  38  40
  42  50  51  67  68  74  78  79  92 158 162 177 187 191 209 225 261 284
 292 314 328 374 402 403 409 429 473 490 499 516 545 557 572 575 607 624
 638 639 671 703 719 744 753 754 778 790 813 815 848 862 865 876 911]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove low confidence detections</span>
<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_scores</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_MIN_CONFIDENCE</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Remove boxes below </span><span class="si">{}</span><span class="s2"> confidence. Keep </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_MIN_CONFIDENCE</span><span class="p">,</span> <span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Remove boxes below 0.5 confidence. Keep 67:
[  0   2   4   5   6   8   9  16  17  18  19  25  30  36  37  38  40  42
  50  51  67  68  74  78  79 158 162 177 187 191 209 225 284 292 314 328
 374 402 403 409 429 473 490 499 516 545 557 575 607 624 638 639 671 703
 719 744 753 754 778 790 813 815 848 862 865 876 911]
</pre></div>
</div>
</div>
</div>
</section>
<section id="per-class-non-max-suppression">
<h3>Per-Class Non-Max Suppression<a class="headerlink" href="#per-class-non-max-suppression" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply per-class non-max suppression</span>
<span class="n">pre_nms_boxes</span> <span class="o">=</span> <span class="n">refined_proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<span class="n">pre_nms_scores</span> <span class="o">=</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
<span class="n">pre_nms_class_ids</span> <span class="o">=</span> <span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>

<span class="n">nms_keep</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">class_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pre_nms_class_ids</span><span class="p">):</span>
    <span class="c1"># Pick detections of this class</span>
    <span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pre_nms_class_ids</span> <span class="o">==</span> <span class="n">class_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Apply NMS</span>
    <span class="n">class_keep</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">non_max_suppression</span><span class="p">(</span><span class="n">pre_nms_boxes</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> 
                                            <span class="n">pre_nms_scores</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span>
                                            <span class="n">config</span><span class="o">.</span><span class="n">DETECTION_NMS_THRESHOLD</span><span class="p">)</span>
    <span class="c1"># Map indicies</span>
    <span class="n">class_keep</span> <span class="o">=</span> <span class="n">keep</span><span class="p">[</span><span class="n">ixs</span><span class="p">[</span><span class="n">class_keep</span><span class="p">]]</span>
    <span class="n">nms_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">nms_keep</span><span class="p">,</span> <span class="n">class_keep</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:22}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">class_id</span><span class="p">][:</span><span class="mi">20</span><span class="p">],</span> 
                                   <span class="n">keep</span><span class="p">[</span><span class="n">ixs</span><span class="p">],</span> <span class="n">class_keep</span><span class="p">))</span>

<span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">keep</span><span class="p">,</span> <span class="n">nms_keep</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kept after per-class NMS: </span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keep</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>person                : [  0   2   5   6   9  67  68  74  79 158 162 187 191 225 284 374 403 409
 429 490 545 557 575 607 638 671 703 744 753 754 778 790 813 848 862 876
 911] -&gt; [  0 162   9   2 671]
car                   : [ 16  18  30  36  51 177 314 328 499 624 815] -&gt; [30]
airplane              : [  4   8  17  19  25  37  38  40  42  50  78 209 292 402 473 516 639 719
 865] -&gt; [78 19]

Kept after per-class NMS: 8
[  0   2   9  19  30  78 162 671]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show final detections</span>
<span class="n">ixs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">))</span>  <span class="c1"># Display all</span>
<span class="c1"># ixs = np.random.randint(0, len(keep), 10)  # Display random sample</span>
<span class="n">captions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span> <span class="n">roi_scores</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">])]</span>
<span class="n">visualize</span><span class="o">.</span><span class="n">draw_boxes</span><span class="p">(</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">boxes</span><span class="o">=</span><span class="n">proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span>
    <span class="n">refined_boxes</span><span class="o">=</span><span class="n">refined_proposals</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">],</span>
    <span class="n">visibilities</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_class_ids</span><span class="p">[</span><span class="n">keep</span><span class="p">][</span><span class="n">ixs</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="n">captions</span><span class="o">=</span><span class="n">captions</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Detections after NMS&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">get_ax</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_45_0.png" src="../../../../../_images/inspect_model_45_0.png" />
</div>
</div>
</section>
</section>
</section>
<section id="stage-3-generating-masks">
<h1>Stage 3: Generating Masks<a class="headerlink" href="#stage-3-generating-masks" title="Permalink to this headline">#</a></h1>
<p>This stage takes the detections (refined bounding boxes and class IDs) from the previous layer and runs the mask head to generate segmentation masks for every instance.</p>
<section id="a-mask-targets">
<h2>3.a Mask Targets<a class="headerlink" href="#a-mask-targets" title="Permalink to this headline">#</a></h2>
<p>These are the training targets for the mask branch</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">gt_mask</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_48_0.png" src="../../../../../_images/inspect_model_48_0.png" />
</div>
</div>
</section>
<section id="b-predicted-masks">
<h2>3.b Predicted Masks<a class="headerlink" href="#b-predicted-masks" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get predictions of mask head</span>
<span class="n">mrcnn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;detections&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_detection&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;masks&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;mrcnn_mask&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>

<span class="c1"># Get detection class IDs. Trim zero padding.</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">mrcnn</span><span class="p">[</span><span class="s1">&#39;detections&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
<span class="n">det_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">det_class_ids</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">det_class_ids</span> <span class="o">=</span> <span class="n">det_class_ids</span><span class="p">[:</span><span class="n">det_count</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> detections: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">det_count</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">class_names</span><span class="p">)[</span><span class="n">det_class_ids</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>detections               shape: (1, 100, 6)           min:    0.00000  max:  844.00000
masks                    shape: (1, 100, 28, 28, 81)  min:    0.00000  max:    0.99984
8 detections: [&#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;person&#39; &#39;airplane&#39; &#39;airplane&#39; &#39;car&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Masks</span>
<span class="n">det_boxes</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">denorm_boxes</span><span class="p">(</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;detections&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
<span class="n">det_mask_specific</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mrcnn</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> 
                              <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">det_class_ids</span><span class="p">)])</span>
<span class="n">det_masks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">utils</span><span class="o">.</span><span class="n">unmold_mask</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">det_boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">det_mask_specific</span><span class="p">)])</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;det_mask_specific&quot;</span><span class="p">,</span> <span class="n">det_mask_specific</span><span class="p">)</span>
<span class="n">log</span><span class="p">(</span><span class="s2">&quot;det_masks&quot;</span><span class="p">,</span> <span class="n">det_masks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>det_mask_specific        shape: (8, 28, 28)           min:    0.00001  max:    0.99984
det_masks                shape: (8, 1024, 1024)       min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">det_mask_specific</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_52_0.png" src="../../../../../_images/inspect_model_52_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_images</span><span class="p">(</span><span class="n">det_masks</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_53_0.png" src="../../../../../_images/inspect_model_53_0.png" />
</div>
</div>
</section>
</section>
<section id="visualize-activations">
<h1>Visualize Activations<a class="headerlink" href="#visualize-activations" title="Permalink to this headline">#</a></h1>
<p>In some cases it helps to look at the output from different layers and visualize them to catch issues and odd patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get activations of a few sample layers</span>
<span class="n">activations</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">run_graph</span><span class="p">([</span><span class="n">image</span><span class="p">],</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;input_image&quot;</span><span class="p">,</span>        <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;input_image&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">)),</span>
    <span class="p">(</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">,</span>          <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>  <span class="c1"># for resnet100</span>
    <span class="p">(</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">,</span>           <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;roi&quot;</span><span class="p">,</span>                <span class="n">model</span><span class="o">.</span><span class="n">keras_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">output</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>input_image              shape: (1, 1024, 1024, 3)    min: -123.70000  max:  151.10001
res4w_out                shape: (1, 64, 64, 1024)     min:    0.00000  max:   54.64681
rpn_bbox                 shape: (1, 65472, 4)         min:  -12.26412  max:   18.18265
roi                      shape: (1, 1000, 4)          min:    0.00000  max:    1.00000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Input image (normalized)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">modellib</span><span class="o">.</span><span class="n">unmold_image</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;input_image&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">config</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_56_0.png" src="../../../../../_images/inspect_model_56_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Backbone feature map</span>
<span class="n">display_images</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;res4w_out&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,:,:</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_57_0.png" src="../../../../../_images/inspect_model_57_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Histograms of RPN bounding box deltas</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dw&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;dh&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;rpn_bbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">3</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_58_0.png" src="../../../../../_images/inspect_model_58_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Distribution of y, x coordinates of generated proposals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;y1, x1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;y2, x2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">activations</span><span class="p">[</span><span class="s2">&quot;roi&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../../../_images/inspect_model_59_0.png" src="../../../../../_images/inspect_model_59_0.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./aiml-common/lectures/scene-understanding/semantic-segmentation/maskrcnn-semantic-segmentation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="inspect_data.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Mask R-CNN - Inspect Training Data</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="inspect_weights.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Mask R-CNN - Inspect Weights of a Trained Model</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Pantelis Monogioudis, Ph.D<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>